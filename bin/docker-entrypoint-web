#!/usr/bin/env bash

set -e

cd /app/backend

# Run database migrations with retry for serverless databases
echo "Running database migrations..."
MAX_RETRIES=5
RETRY_COUNT=0

until python manage.py migrate --noinput; do
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
        echo "Migration failed after $MAX_RETRIES attempts"
        exit 1
    fi
    echo "Migration failed, retrying in $((RETRY_COUNT * 2)) seconds (attempt $RETRY_COUNT/$MAX_RETRIES)..."
    sleep $((RETRY_COUNT * 2))
done

# Create default superuser using management command
echo "Creating default superuser..."
python manage.py create_default_superuser

# If supervisord is being started, ensure we're root and run it directly
if [[ "$1" == "supervisord" ]]; then
    echo "Starting supervisord (nginx + django + bun-ssr)..."
    exec "$@"
fi

# Otherwise run the command as usual
exec "$@"
