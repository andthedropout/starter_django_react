#!/usr/bin/env bash

set -eo pipefail

PROJECT_NAME="${1}"

# Validate argument is provided
if [ -z "${PROJECT_NAME}" ]; then
    echo "Usage: ${0} PROJECT_NAME"
    echo ""
    echo "Example: ${0} myproject"
    echo ""
    echo "PROJECT_NAME must be:"
    echo "  ‚Ä¢ Lowercase"
    echo "  ‚Ä¢ Start with a letter"
    echo "  ‚Ä¢ Contain only letters, numbers, and underscores"
    exit 1
fi

# Validate project name format
if [[ ! "${PROJECT_NAME}" =~ ^[a-z][a-z0-9_]*$ ]]; then
    echo "‚ùå Error: PROJECT_NAME must be lowercase, start with a letter, and contain only letters, numbers, and underscores"
    echo "   Examples: myproject, my_project, myproject123"
    exit 1
fi

# Check if name is different from current
CURRENT_NAME=$(grep -E "^PROJECT_NAME=" .env 2>/dev/null | cut -d'=' -f2 || echo "starter_django_react")
if [ "${PROJECT_NAME}" = "${CURRENT_NAME}" ]; then
    echo "‚ö†Ô∏è  Project is already named '${PROJECT_NAME}'"
    echo "   No changes needed."
    exit 0
fi

cat << EOF
‚ö†Ô∏è  WARNING: Renaming Project
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

This will rename your project from '${CURRENT_NAME}' to '${PROJECT_NAME}'.

The database will be deleted and recreated with the new name.
This is necessary because Docker volumes are named after the project.

EOF

while true; do
    read -p "Continue and run 'docker compose down -v'? (y/n): " -r yn
    case "${yn}" in
        [Yy]* )
          printf "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
          docker compose down -v
          printf "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
          break;;
        [Nn]* )
          echo "Cancelled. No changes made."
          exit;;
        * ) echo "Please answer y or n";;
    esac
done

# Update .env file
if [ -f .env ]; then
  echo "üìù Updating .env..."
  perl -i -pe "s/^PROJECT_NAME=.*/PROJECT_NAME=${PROJECT_NAME}/g" .env
  echo "‚úÖ .env updated"
fi

# Update .env.example
if [ -f .env.example ]; then
  echo "üìù Updating .env.example..."
  perl -i -pe "s/^PROJECT_NAME=.*/PROJECT_NAME=${PROJECT_NAME}/g" .env.example
  echo "‚úÖ .env.example updated"
fi

# Update frontend package.json name
if [ -f frontend/package.json ]; then
  KEBAB_NAME=$(echo ${PROJECT_NAME} | tr '_' '-')
  echo "üìù Updating frontend/package.json..."
  perl -i -pe "s/\"name\": \".*\"/\"name\": \"${KEBAB_NAME}\"/g" frontend/package.json
  echo "‚úÖ frontend/package.json updated (name: ${KEBAB_NAME})"
fi

cat << EOF

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ Project Renamed Successfully!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Changes made:
  ‚Ä¢ PROJECT_NAME:           ${CURRENT_NAME} ‚Üí ${PROJECT_NAME}
  ‚Ä¢ COMPOSE_PROJECT_NAME:   Derived from \${PROJECT_NAME}
  ‚Ä¢ VITE_PROJECT_NAME:      Derived from \${PROJECT_NAME}
  ‚Ä¢ POSTGRES_USER:          Derived from \${PROJECT_NAME}
  ‚Ä¢ POSTGRES_DB:            Derived from \${PROJECT_NAME}
  ‚Ä¢ Cookie names:           ${PROJECT_NAME}_sessionid, ${PROJECT_NAME}_csrftoken
  ‚Ä¢ package.json:           ${KEBAB_NAME}

Next steps:
  1. Start your services:   docker compose up --build -d
  2. Run migrations:        docker compose exec web python manage.py migrate
  3. Create superuser:      docker compose exec web python manage.py createsuperuser

EOF

# Ask if they want to reinitialize git
function init_git_repo {
  [ -d .git/ ] && rm -rf .git/

  cat << EOF

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
$(git init)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

EOF

  git symbolic-ref HEAD refs/heads/main
}

while true; do
    read -p "Initialize a new git repository? (y/n): " -r yn
    case "${yn}" in
        [Yy]* ) init_git_repo; break;;
        [Nn]* ) break;;
        * ) echo "Please answer y or n";;
    esac
done

cat << EOF

üéâ All done! Your project '${PROJECT_NAME}' is ready to go.

You can run this script again anytime to change the project name.

Happy coding!

EOF
