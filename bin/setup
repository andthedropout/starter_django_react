#!/usr/bin/env bash

set -e

echo "ğŸš€ Django + React Template Setup"
echo "================================="
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Error: Docker is not running"
    echo "   Please start Docker and try again"
    exit 1
fi

# Step 1: Create .env if it doesn't exist
if [ ! -f .env ]; then
    echo "ğŸ“ Creating .env from .env.example..."
    cp .env.example .env
    echo "âœ… .env created"
    echo ""
else
    echo "âœ… .env already exists"
    echo ""
fi

# Step 2: Project Configuration
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Project Configuration"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "IMPORTANT: Each clone of this template needs:"
echo "  â€¢ Unique project name (avoids Docker conflicts)"
echo "  â€¢ Unique port (if running multiple projects simultaneously)"
echo ""
echo "Current settings:"
echo "  â€¢ Project name: starter_django_react"
echo "  â€¢ Port: 8000"
echo ""

# Check if port 8000 is already in use
PORT_IN_USE=false
if lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null 2>&1; then
    PORT_IN_USE=true
    echo "âš ï¸  WARNING: Port 8000 is already in use!"
    echo ""
fi

# Ask for project name
PROJECT_NAME=""
while true; do
    read -p "Enter project name [starter_django_react]: " -r input
    PROJECT_NAME="${input:-starter_django_react}"

    # Validate project name
    if [[ ! "${PROJECT_NAME}" =~ ^[a-z][a-z0-9_]*$ ]]; then
        echo "âŒ Invalid name. Use lowercase letters, numbers, underscores only (must start with letter)"
        continue
    fi

    break
done

# Ask for port
PORT=""
while true; do
    if [ "$PORT_IN_USE" = true ]; then
        read -p "Enter port to run on [8001]: " -r input
        PORT="${input:-8001}"
    else
        read -p "Enter port to run on [8000]: " -r input
        PORT="${input:-8000}"
    fi

    # Validate port number
    if ! [[ "${PORT}" =~ ^[0-9]+$ ]] || [ "${PORT}" -lt 1024 ] || [ "${PORT}" -gt 65535 ]; then
        echo "âŒ Invalid port. Use a number between 1024-65535"
        continue
    fi

    # Check if chosen port is available (unless it's the default and we already know it's in use)
    if [ "${PORT}" != "8000" ] || [ "$PORT_IN_USE" = false ]; then
        if lsof -Pi :${PORT} -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo "âŒ Port ${PORT} is already in use. Choose another port."
            continue
        fi
    fi

    break
done

echo ""
echo "âœ¨ Configuration:"
echo "  â€¢ Project: ${PROJECT_NAME}"
echo "  â€¢ Port: ${PORT}"
echo ""

# Update .env file with chosen values
echo "ğŸ“ Updating .env with your configuration..."
perl -i -pe "s/^PROJECT_NAME=.*/PROJECT_NAME=${PROJECT_NAME}/g" .env
perl -i -pe "s/^PORT=.*/PORT=${PORT}/g" .env
perl -i -pe "s/^export COMPOSE_PROJECT_NAME=.*/export COMPOSE_PROJECT_NAME=\${PROJECT_NAME}/g" .env
perl -i -pe "s/^VITE_PROJECT_NAME=.*/VITE_PROJECT_NAME=\${PROJECT_NAME}/g" .env
perl -i -pe "s/^export POSTGRES_USER=.*/export POSTGRES_USER=\${PROJECT_NAME}/g" .env
perl -i -pe "s/^export POSTGRES_DB=.*/export POSTGRES_DB=\${PROJECT_NAME}/g" .env

# If project name changed, also update package.json
if [ "${PROJECT_NAME}" != "starter_django_react" ]; then
    KEBAB_NAME=$(echo ${PROJECT_NAME} | tr '_' '-')
    perl -i -pe "s/\"name\": \".*\"/\"name\": \"${KEBAB_NAME}\"/g" frontend/package.json
    echo "âœ… Updated package.json name to: ${KEBAB_NAME}"
fi

echo "âœ… Configuration updated"
echo ""

# Step 3: Start Docker services
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Starting Docker Services"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ³ Building and starting Docker services (this may take a few minutes)..."
echo ""

docker compose up --build -d

echo ""
echo "âœ… Services started"
echo ""

# Step 4: Wait for PostgreSQL to be ready
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Waiting for Database"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "â³ Waiting for PostgreSQL to be ready..."

MAX_ATTEMPTS=30
ATTEMPT=0

while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
    if docker compose exec -T postgres pg_isready -U starter_django_react > /dev/null 2>&1; then
        echo "âœ… PostgreSQL is ready"
        echo ""
        break
    fi

    ATTEMPT=$((ATTEMPT + 1))
    if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
        echo "âŒ PostgreSQL failed to start after 30 seconds"
        echo "   Check logs: docker compose logs postgres"
        exit 1
    fi

    sleep 1
done

# Step 5: Run migrations
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Running Database Migrations"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Running migrations..."
echo ""

docker compose exec -T web python manage.py migrate --noinput

echo ""
echo "âœ… Migrations complete"
echo ""

# Step 6: Success message
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Setup Complete!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸŒ Your application is running at:"
echo "   Frontend:  http://localhost:${PORT}"
echo "   Admin:     http://localhost:${PORT}/admin"
echo ""
echo "ğŸ‘¤ Default admin credentials:"
echo "   Username:  admin"
echo "   Password:  changeme"
echo ""
echo "ğŸ“ Useful commands:"
echo "   View logs:        docker compose logs -f"
echo "   Stop services:    docker compose down"
echo "   Restart:          docker compose restart"
echo "   Shell access:     docker compose exec web bash"
echo ""
echo "ğŸ“š Next steps:"
echo "   1. Visit http://localhost:${PORT} to see your app"
echo "   2. Check out the README for development workflow"
echo "   3. Customize your theme in .env (VITE_FRONTEND_THEME)"
echo ""
echo "Happy coding! ğŸ‰"
echo ""
